<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="header-top">
                <h1>üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
                <a href="/admin-logout" class="btn btn-danger">–í—ã—Ö–æ–¥</a>
            </div>
            <p class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏</p>
        </header>

        <main class="main-content">
            <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞ -->
            <section class="section add-absence-section">
                <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫</h2>
                <form id="absenceForm" class="form">
                    <div class="form-group">
                        <label for="name">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞:</label>
                        <select id="name" name="name" required>
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                            <% friends.forEach(friend => { %>
                                <option value="<%= friend %>"><%= friend %></option>
                            <% }); %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="date">–î–∞—Ç–∞ —Å–±–æ—Ä–∞:</label>
                        <input type="date" id="date" name="date" required>
                    </div>

                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫</button>
                    <span id="formMessage" class="message"></span>
                </form>
            </section>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ -->
            <section class="section management-section">
                <h2>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–∞–º–∏</h2>
                
                <% if (absences.length === 0) { %>
                    <p class="empty-message">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –ø—Ä–æ–ø—É—Å–∫–∞—Ö</p>
                <% } else { %>
                    <div class="admin-list">
                        <% stats.forEach(stat => { %>
                            <% if (stat.totalAbsences > 0) { %>
                                <div class="admin-item">
                                    <button type="button" class="admin-button" onclick="toggleAdminDates(this, '<%= stat.name %>')">
                                        <span class="admin-name"><%= stat.name %></span>
                                        <span class="admin-count"><%= stat.totalAbsences %> —Ä–∞–∑</span>
                                        <span class="admin-sum">üí∞ <%= stat.totalDebtAmount %> —Ç–≥</span>
                                        <% if (stat.paidAmount > 0) { %>
                                            <span class="paid-badge">‚úÖ –¢—É–ª–∞–Ω–¥–∏ <%= stat.paidAmount %> —Ç–≥</span>
                                        <% } %>
                                        <% if (stat.overpayment > 0) { %>
                                            <span class="paid-badge" style="background: #f1c40f; color: #000;">‚ö†Ô∏è –û—Ä—Ç–∏“õ—á–∞ <%= stat.overpayment %> —Ç–≥</span>
                                        <% } %>
                                        <span class="toggle-icon">‚ñº</span>
                                    </button>
                                    <div class="admin-dates" style="display: none;">
                                        <ul class="admin-dates-list">
                                            <% const personAbsences = absences.filter(a => a.name === stat.name).sort((a, b) => new Date(b.date) - new Date(a.date)); %>
                                            <% personAbsences.forEach(absence => { %>
                                                <li class="admin-date-item">
                                                    <span class="date-value"><%= new Date(absence.date + 'T00:00:00').toLocaleDateString('ru-RU', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }) %></span>
                                                    <span class="amount">2000 —Ç–≥</span>
                                                    <button type="button" class="btn btn-small btn-danger" onclick="removeAbsence('<%= absence.name %>', '<%= absence.date %>')">–£–¥–∞–ª–∏—Ç—å</button>
                                                </li>
                                            <% }); %>
                                        </ul>
                                    </div>
                                </div>
                            <% } %>
                        <% }); %>
                    </div>
                <% } %>
            </section>

            <!-- –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç -->
            <section class="section total-section">
                <h2>üíµ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç</h2>
                <div class="total-info">
                    <div class="total-card total-debt">
                        <div class="total-label">–û–±—â–∏–π –¥–æ–ª–≥:</div>
                        <div class="total-value"><%= totalDebt %> —Ç–≥</div>
                    </div>
                    <div class="total-card paid-count">
                        <div class="total-label">–û–ø–ª–∞—á–µ–Ω–æ:</div>
                        <div class="total-value"><%= totalPaid %> —Ç–≥</div>
                    </div>
                </div>
            </section>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Å–æ–π -->
            <section class="section cash-section">
                <h2>üí≥ –ö–∞—Å—Å–∞ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏)</h2>
                
                <div class="cash-add">
                    <form id="paymentForm" class="form">
                        <div class="form-group">
                            <label for="paymentName">–í—ã–±–µ—Ä–∏—Ç–µ —á–µ–ª–æ–≤–µ–∫–∞:</label>
                            <select id="paymentName" name="paymentName" required>
                                <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                                <% stats.forEach(stat => { %>
                                    <option value="<%= stat.name %>"><%= stat.name %> (–î–æ–ª–≥: <%= stat.totalDebtAmount %> —Ç–≥, –æ–ø–ª–∞—á–µ–Ω–æ: <%= stat.paidAmount %> —Ç–≥)</option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="paymentAmount">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (—Ç–≥):</label>
                            <input type="number" id="paymentAmount" name="amount" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" required>
                        </div>
                        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</button>
                        <span id="paymentMessage" class="message"></span>
                    </form>
                </div>

                <% if (payments.length === 0) { %>
                    <p class="empty-message">–ù–∏–∫—Ç–æ –µ—â–µ –Ω–µ –æ–ø–ª–∞—Ç–∏–ª</p>
                <% } else { %>
                    <div class="payments-list">
                        <% payments.forEach((payment, index) => { %>
                            <div class="payment-item">
                                <span class="payment-name">‚úÖ <%= payment.name %></span>
                                <span class="payment-amount"><%= payment.amount %> —Ç–≥</span>
                                <span class="payment-detail">(<%= payment.date %>)</span>
                                <button type="button" class="btn btn-small btn-danger" onclick="removePayment('<%= index %>')">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </section>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ -->
            <section class="section expense-section">
                <h2>üí∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞–º–∏</h2>
                
                <div class="expense-add">
                    <form id="expenseForm" class="form">
                        <div class="form-group">
                            <label for="expenseAmount">–°—É–º–º–∞ —Ä–∞—Å—Ö–æ–¥–∞ (—Ç–≥):</label>
                            <input type="number" id="expenseAmount" name="amount" min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" required>
                        </div>
                        <div class="form-group">
                            <label for="expenseComment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π/–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                            <textarea id="expenseComment" name="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê—Ä–µ–Ω–¥–∞ —Å–∞–ª–∞, –Ω–∞–ø–∏—Ç–∫–∏..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                        <span id="expenseMessage" class="message"></span>
                    </form>
                </div>

                <div class="financial-summary">
                    <div class="summary-card">
                        <div class="summary-label">–ù—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å:</div>
                        <div class="summary-value"><%= totalDebt %> —Ç–≥</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">–û–ø–ª–∞—á–µ–Ω–æ:</div>
                        <div class="summary-value"><%= totalPaid %> —Ç–≥</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">–†–∞—Å—Ö–æ–¥—ã:</div>
                        <div class="summary-value"><%= totalExpenses %> —Ç–≥</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">–í –∫–∞—Å—Å–µ:</div>
                        <div class="summary-value"><%= cashBalance %> —Ç–≥</div>
                    </div>
                </div>

                <% if (expenses.length === 0) { %>
                    <p class="empty-message">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
                <% } else { %>
                    <div class="expenses-list">
                        <% expenses.forEach((expense, index) => { %>
                            <div class="expense-item">
                                <div class="expense-header">
                                    <span class="expense-amount">üí∏ <%= expense.amount %> —Ç–≥</span>
                                    <span class="expense-date"><%= expense.date || '–ë–µ–∑ –¥–∞—Ç—ã' %></span>
                                </div>
                                <div class="expense-comment"><%= expense.comment %></div>
                                <button type="button" class="btn btn-small btn-danger" onclick="removeExpense('<%= index %>')">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </section>

            <!-- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
            <section class="section export-section">
                <h2>üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h2>
                <a href="/export-csv" class="btn btn-secondary">–°–∫–∞—á–∞—Ç—å CSV</a>
            </section>
        </main>
    </div>

    <script src="/js/app.js"></script>
</body>
</html>
